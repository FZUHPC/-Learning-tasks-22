# 22级第一次学习任务（安装部分）

安装HPL的时候遇到了非常非常多的问题，有些报错实际就是oneapi下载的最后一步出了问题导致的。

难怪找不到解决方法。

[TOC]



## oneapi安装

需要将source ~/intel/oneapi/setvars.sh添加~/.bashrc中，不然which mpiicc的时候就无法显示，导致安装HPL时候显示没有找到mpiicc（如果不用mpiicc，而用mpicc的话会出现很多报错。）

错误（还有一些错误，但是没有截图）：

![image-20230318230037098](C:\Users\yqq\AppData\Roaming\Typora\typora-user-images\image-20230318230037098.png)

![](C:\Users\yqq\Pictures\Screenshots\屏幕截图 2023-03-16 194741.png)

![](C:\Users\yqq\Pictures\Screenshots\屏幕截图 2023-03-16 192901.png)

## HPL安装

真的遇到好多问题，不过解决了就好。

> ### gcc9.4.0安装
>
> gcc降级：[参考1](https://blog.csdn.net/u013862444/article/details/98629581?ops_request_misc=&request_id=&biz_id=102&utm_term=gcc%E9%99%8D%E7%BA%A7&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-2-98629581.142^v74^insert_down2,201^v4^add_ask,239^v2^insert_chatgpt&spm=1018.2226.3001.4187)        [参考2](https://blog.csdn.net/qq_33160790/article/details/80464473?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167915484416800213021406%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=167915484416800213021406&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-11-80464473-null-null.142^v74^insert_down2,201^v4^add_ask,239^v2^insert_chatgpt&utm_term=gcc%E9%99%8D%E7%BA%A7&spm=1018.2226.3001.4187)
>
> gcc版本9.5就可以了的，但是在走投无路中花了几个小时安装了9.4，但是并不是因为版本不够旧导致的，而是因为上述问题。不过既然是推荐的就不改回去了。
>
> 一些参考：[gcc编译器下载与手动安装](https://blog.csdn.net/yanbw/article/details/128483364?ops_request_misc=&request_id=&biz_id=102&utm_term=%E5%A6%82%E4%BD%95%E4%B8%8B%E8%BD%BDgcc-9.4&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-128483364.nonecase&spm=1018.2226.3001.4187)
>
> 安装依赖时，由于没有换过源，全都无法下载，就wget了安装包，安装源：[清华大学开源软件镜像站](https://mirrors.tuna.tsinghua.edu.cn/gnu/)
>
> 期间还遇到报错：
>
> ```
> configure: error: unknown check category release–enable-languages=c 
> make[2]: *** [Makefile:4375：configure-stage1-gcc] 错误 1
> ```
>
> 但是当时没有记录，忘记解决方法了。

一些找到解决方法的报错：

### /usr/bin/ld:cannot find -l***

解决：在/usr/lib中创建一个lib***的链接。（用locate搜索）

![](C:\Users\yqq\Pictures\Screenshots\屏幕截图 2023-03-17 225924.png)

![](C:\Users\yqq\Pictures\Screenshots\屏幕截图 2023-03-17 225914.png)

### cannot open source file “***.h”

就是头文件的路径出了问题。可以locate一下，然后把出错文件里面的<***.h>改成绝对路径。

但是在HPL安装时，我遇到一系列`<bits/***.h>`或者`<sys/***.h>`的报错，最恶心的是错误是一个一个出的（改完一个再make，下一个错误才出来，这是正常的），我在修改了很多之后才发现只需要两(三)条命令就够了。

一系列错误：

```
/usr/include/features.h(486): catastrophic error: cannot open source file "sys/cdefs.h"
  #  include <sys/cdefs.h>
                          ^
                          
/usr/include/x86_64-linux-gnu/sys/cdefs.h(559): catastrophic error: cannot open source file "bits/wordsize.h"
  # include <bits/wordsize.h>
                             ^
/usr/include/features.h(511): catastrophic error: cannot open source file "gnu/stubs.h"
  #include <gnu/stubs.h>
                        ^

/usr/include/x86_64-linux-gnu/gnu/stubs.h(10): catastrophic error: cannot open source file "gnu/stubs-64.h"
  # include <gnu/stubs-64.h>
                            ^
                            
/usr/include/x86_64-linux-gnu/bits/types.h(27): catastrophic error: cannot open source file "bits/wordsize.h"
  #include <bits/wordsize.h>
                            ^
/usr/include/x86_64-linux-gnu/bits/types.h(29): catastrophic error: cannot open source file "bits/timesize.h"
  #include <bits/timesize.h>
                            ^

/usr/include/x86_64-linux-gnu/bits/types.h(143): catastrophic error: cannot open source file "bits/typesizes.h"
  #include <bits/typesizes.h>	/* Defines __*_T_TYPE macros.  */
                             	                                 ^

/usr/include/x86_64-linux-gnu/bits/types.h(145): catastrophic error: cannot open source file "bits/time64.h"
  #include <bits/time64.h>	/* Defines __TIME*_T_TYPE macros.  */
                          	                                     ^
```

一个个修改（只是截取，跟上面可能不对应，不止修改了这些）：

```
yang@yang-virtual-machine:~/hpl-2.3$ locate bits/types/__fpos_t.h
/usr/include/x86_64-linux-gnu/bits/types/__fpos_t.h
yang@yang-virtual-machine:~/hpl-2.3$ locate bits/types/__fpos64_t.h
/usr/include/x86_64-linux-gnu/bits/types/__fpos64_t.h
yang@yang-virtual-machine:~/hpl-2.3$ locate bits/types/__FILE.h
/usr/include/x86_64-linux-gnu/bits/types/__FILE.h
yang@yang-virtual-machine:~/hpl-2.3$ locate bits/types/FILE.h
/usr/include/x86_64-linux-gnu/bits/types/FILE.h
yang@yang-virtual-machine:~/hpl-2.3$ locate bits/types/struct_FILE.h
/usr/include/x86_64-linux-gnu/bits/types/struct_FILE.h
yang@yang-virtual-machine:~/hpl-2.3$ locate bits/types/cookie_io_functions_t.h
/usr/include/x86_64-linux-gnu/bits/types/cookie_io_functions_t.h
```

```
root@yang-virtual-machine:/usr/include# vim /usr/include/stdio.h
root@yang-virtual-machine:/usr/include# vim /usr/include/x86_64-linux-gnu/bits/types.h
root@yang-virtual-machine:/usr/include# vim /usr/include/x86_64-linux-gnu/bits/types.h
root@yang-virtual-machine:/usr/include# vim /usr/include/x86_64-linux-gnu/bits/types.h
root@yang-virtual-machine:/usr/include# vim /usr/include/x86_64-linux-gnu/bits/types.h
root@yang-virtual-machine:/usr/include# vim /usr/include/x86_64-linux-gnu/bits/types.h
```

两条命令(应该还需要gnu的，但是估计被我手动改完了)：

```
root@yang-virtual-machine:/usr/include# ln -s /usr/include/x86_64-linux-gnu/bits /usr/include/bits
root@yang-virtual-machine:/usr/include# ln -s /usr/include/x86_64-linux-gnu/sys
```

<gnu/stubs.h>

![image-20230318201457101](C:\Users\yqq\AppData\Roaming\Typora\typora-user-images\image-20230318201457101.png)

![](C:\Users\yqq\Pictures\Screenshots\屏幕截图 2023-03-18 205846.png)

### 运行./xhpl发生错误

经过几天的失败，终于成功生成了.dat和xhpl，结果出现错误如下：



![image-20230319000414182](C:\Users\yqq\AppData\Roaming\Typora\typora-user-images\image-20230319000414182.png)

![image-20230319000450629](C:\Users\yqq\AppData\Roaming\Typora\typora-user-images\image-20230319000450629.png)

原来是Ubuntu的内存和处理器数设置不当导致的。

更改为8内存，4处理器（2CPU，2核）：

运行结果：

![image-20230319000808604](C:\Users\yqq\AppData\Roaming\Typora\typora-user-images\image-20230319000808604.png)

## 安装HPCG

make的时候又出现了头文件错误

结果：

![image-20230319104646126](C:\Users\yqq\AppData\Roaming\Typora\typora-user-images\image-20230319104646126.png)

![](C:\Users\yqq\Pictures\Screenshots\屏幕截图 2023-03-19 104722.png)

![](C:\Users\yqq\Pictures\Screenshots\屏幕截图 2023-03-19 104734.png)

## HPL.dat文件含义

https://blog.csdn.net/gyx1549624673/article/details/86551466

## 调优

Gfloat = 核心数(CPU几核) 主频(GHz) 每时钟周期浮点运算次数

！！！ 该公式用于计算理论峰值，实际峰值为HPL跑出来的结果 

5. 多进程运行命令 mpirun -np 线程数 ./可执行文件。 例如:4个进程运行xhpl，指令为 mpirun -np 4 ./xhpl

 **在测试调优的时候要保持电源连接，后台少应用甚至无应用，网络连接，如果电脑有性能模 式的话也可以打开，不然有可能会产生较大的数值波动。还有一个就是在调参的时候不要一开始就把数 值开太大了不然会跑很久。最后要测出自己的实际峰值与理论峰值的比值，需要提交（最原始的比值， 以及调优最终的比值**